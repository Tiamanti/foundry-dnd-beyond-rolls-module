(()=>{"use strict";function e(){let e=game.settings.get(a.MODULE_ID,a.COBALT_COOKIE),o=game.settings.get(a.MODULE_ID,a.PROXY_URL);return new Promise(((t,n)=>{fetch(o+"/"+e,{method:"POST"}).then((function(e){e.json().then((e=>{console.log("Successfully got socket token"),t(e)}))})).catch((function(e){var o;o="Error getting cobalt socket token.",ui.notifications.error("DISABLED: "+a.MODULE_NAME+", "+o),game.settings.set(a.MODULE_ID,a.ENABLED,!1),n()}))}))}function o(e,o){return{class:"Roll",options:{},dice:[],formula:e,terms:[],total:o}}function t(e,o){return{class:"Die",options:{},number:1,faces:e,modifiers:[],results:[{result:o,active:!0}]}}let n={};function i(){l.DISABLE_DDB_CALLS?ui.notifications.info(a.MODULE_NAME+" - DDB Calls Disabled"):s()}function s(){console.log("use cobalt cookie to get cobalt socket token"),e().then((e=>{console.log("RESULT "+e.token),function(e){let i=game.settings.get(a.MODULE_ID,a.GAME_ID),l=game.settings.get(a.MODULE_ID,a.PLAYER_ID);game.settings.get(a.MODULE_ID,a.ENABLED)&&(ui.notifications.info(a.MODULE_NAME+" - Attempting DDB Connection"),n=new WebSocket("wss://game-log-api-live.dndbeyond.com/v1?gameId="+i+"&userId="+l+"&stt="+e),n.onopen=function(e){console.log("DDB CONNNECTED"),ui.notifications.info(a.MODULE_NAME+" - Connected to DDB"),setInterval((()=>{n.send('{"data":"ping"}')}),3e5)},n.onmessage=function(e){if("pong"!=e.data){let n=JSON.parse(e.data);"dice/roll/fulfilled"==n.eventType&&function(e){let n=e.rolls[0];console.log(n);let i=o(n.diceNotationStr,n.result.total);n.diceNotation.set.forEach((e=>{e.dice.forEach((e=>{console.log(e),i.terms.push(t(Number(e.dieType.slice(1)),Number(e.dieValue)))}))}));let s=Roll.fromData(i),l={type:CONST.CHAT_MESSAGE_TYPES.ROLL,speaker:{alias:e.context.name},flavor:e.action+" "+n.rollType+" "+n.rollKind,rolls:[s],rollMode:game.settings.get("core","rollMode")};ChatMessage.create(l,{})}(n.data)}},n.onclose=function(e){console.log("DDB DISCONNECTED"),console.log("DDB DISCONNECTED1"),console.log("DDB DISCONNECTED2"),console.log("DDB DISCONNECTED3"),console.log("DDB DISCONNECTED4"),console.log("DDB DISCONNECTED5"),console.log("DDB DISCONNECTED6"),console.log("DDB DISCONNECTED7"),ui.notifications.warn(a.MODULE_NAME+" - Connection to D&D Beyond Lost, wait 5 seconds, reconnect"),setTimeout((function(){s()}),5e3)})}(e.token)}))}const l={DISABLE_DDB_CALLS:!1},a={MODULE_NAME:"D&D Beyond Rolls Module",MODULE_ID:"dd-beyond-rolls-module",PROXY_URL:"cobaltProxy",COBALT_COOKIE:"cobaltCookie",GAME_ID:"gid",PLAYER_ID:"pid",ENABLED:"moduleEnabled"};class D extends FormApplication{getData(){window.open("https://www.paypal.me/rm2kdev")}}Hooks.on("init",(function(){game.settings.register(a.MODULE_ID,a.PROXY_URL,{name:"Cobalt Proxy Url",hint:"Url of the locally running companion app.",scope:"client",config:!0,type:String,default:"http://localhost:8745"}),game.settings.register(a.MODULE_ID,a.COBALT_COOKIE,{name:"Cobalt Cookie",hint:"D&D Beyond Cobalt Cookie used for authentication with DDB.",scope:"client",config:!0,type:String,default:""}),game.settings.register(a.MODULE_ID,a.GAME_ID,{name:"Game ID",hint:"D&D Beyond Game ID used to define which campaign you are connecting in.",scope:"client",config:!0,type:String,default:""}),game.settings.register(a.MODULE_ID,a.PLAYER_ID,{name:"Player ID",hint:"D&D Beyond Player ID used to define which player is observing rolls.",scope:"client",config:!0,type:String,default:""}),game.settings.register(a.MODULE_ID,a.ENABLED,{name:"Enable Module",hint:"When enabled module will attempt connection with DDB.",scope:"client",config:!0,type:Boolean,default:!1,onChange:e=>{e&&i()}}),game.settings.registerMenu(a.MODULE_ID,"mySettingsMenu",{name:"Please Donate",label:"DONATE HERE",hint:"This is my first plugin for foundry, a love letter and thank you to everyone else who has spent the time to go through this process to extend foundry for me and my friends so that we could play D&D in the coolest ways, I have an ungodly amount of time learning foundry development to build this, understanding dnd beyond protocols and debugging and testing this plugin, please dear god buy me a beer if this is useful for you <3",icon:"fas fa-donate",type:D,restricted:!0,config:!0})})),Hooks.on("ready",(function(){game.settings.get(a.MODULE_ID,a.ENABLED)&&i()}))})();